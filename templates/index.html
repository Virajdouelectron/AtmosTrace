<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeteorGlobe - Real-time Meteor Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/globe.gl@2.32.1/dist/globe.gl.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body { margin: 0; }
        #globeViz { width: 100vw; height: 100vh; }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .warning-badge {
            background: #ff4444;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.1);
            color: #ff4444;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="globe-container">
        <div class="time-range-selector">
            <select id="timeRange" class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-700 focus:outline-none focus:border-blue-500">
                <option value="realtime">Real-time</option>
                <option value="1h">Last 1 Hour</option>
                <option value="10h">Last 10 Hours</option>
                <option value="10d">Last 10 Days</option>
                <option value="5m">Last 5 Months</option>
                <option value="custom">Custom Date Range</option>
            </select>
            <div id="customDateRange" class="hidden mt-2 space-y-2">
                <div class="flex space-x-2">
                    <input type="date" id="startDate" class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-700 focus:outline-none focus:border-blue-500">
                    <input type="date" id="endDate" class="bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-700 focus:outline-none focus:border-blue-500">
                </div>
                <button id="applyCustomRange" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Apply Date Range
                </button>
            </div>
        </div>
        <div id="globeViz"></div>
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner"></div>
            <div class="mt-4 text-center">Loading meteor data...</div>
        </div>
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="tooltip" class="tooltip hidden"></div>
    </div>

    <!-- Media Gallery Modal -->
    <div id="mediaModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Meteor Media Gallery</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-button active" data-tab="images">Images</button>
                    <button class="tab-button" data-tab="videos">Videos</button>
                </div>
                <div id="imagesTab" class="tab-content active">
                    <div class="image-gallery"></div>
                </div>
                <div id="videosTab" class="tab-content">
                    <div class="video-gallery"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Show loading spinner
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Hide loading spinner
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            hideLoading();
        }

        // Initialize Globe
        let globe;
        try {
            globe = Globe()
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
                .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
                .width(window.innerWidth)
                .height(window.innerHeight)
                .atmosphereColor('#ffffff')
                .atmosphereAltitude(0.1)
                (document.getElementById('globeViz'));

            // Handle window resize
            window.addEventListener('resize', () => {
                globe.width(window.innerWidth)
                    .height(window.innerHeight);
            });
        } catch (error) {
            showError('Failed to initialize 3D globe. Please refresh the page.');
            console.error('Globe initialization error:', error);
        }

        // Tooltip handling
        const tooltip = document.getElementById('tooltip');
        
        function showTooltip(event, meteor) {
            const { clientX, clientY } = event;
            tooltip.style.left = `${clientX + 10}px`;
            tooltip.style.top = `${clientY + 10}px`;
            
            const warningHtml = meteor.warning ? 
                `<div class="warning-badge mb-2">${meteor.warning}</div>` : '';
            
            tooltip.innerHTML = `
                <div class="space-y-2">
                    ${warningHtml}
                    <div class="font-bold">${meteor.type}</div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <div>Magnitude:</div>
                        <div>${meteor.magnitude}</div>
                        <div>Energy:</div>
                        <div>${meteor.energy} kt</div>
                        <div>Impact Energy:</div>
                        <div>${meteor.impact_energy} kt</div>
                        <div>Velocity:</div>
                        <div>${meteor.velocity} km/s</div>
                        <div>Altitude:</div>
                        <div>${meteor.altitude} km</div>
                        <div>Time (UTC):</div>
                        <div>${meteor.utc_time}</div>
                    </div>
                    <a href="${meteor.mapLink}" target="_blank" 
                       class="block mt-2 text-center text-blue-400 hover:text-blue-300 bg-blue-900/50 p-1 rounded">
                        View on Map
                    </a>
                </div>
            `;
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

        // Fetch and update meteor data
        async function fetchMeteors() {
            showLoading();
            try {
                const response = await fetch('/api/meteors');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const meteors = await response.json();
                
                if (!meteors || meteors.length === 0) {
                    showError('No meteor data available at the moment. Please try again later.');
                    return;
                }

                // Clear existing points and arcs
                globe.pointsData([]).arcsData([]);
                
                // Add new points and arcs
                const points = meteors.map(meteor => ({
                    ...meteor,
                    color: meteor.magnitude >= 6 ? '#ff0000' : 
                           meteor.magnitude >= 5 ? '#ff4444' : '#ffa500',
                    radius: meteor.magnitude >= 6 ? 0.5 : 0.3,
                    label: meteor.warning ? '🚨' : '☄️'
                }));

                const arcs = meteors.map(meteor => ({
                    startLat: meteor.entryLat,
                    startLng: meteor.entryLng,
                    endLat: meteor.lat,
                    endLng: meteor.lng,
                    color: meteor.magnitude >= 6 ? '#ff0000' : 
                           meteor.magnitude >= 5 ? '#ff4444' : '#ffa500'
                }));

                globe.pointsData(points)
                    .arcsData(arcs)
                    .pointAltitude(0.1)
                    .pointColor('color')
                    .pointRadius('radius')
                    .pointLabel('label')
                    .arcColor('color')
                    .arcAltitude(0.3)
                    .arcStroke(0.5)
                    .arcDashLength(0.4)
                    .arcDashGap(0.2)
                    .arcDashAnimateTime(2000);

                // Add hover effects
                globe.onPointHover(showTooltip)
                    .onPointUnhover(hideTooltip);

                hideLoading();
            } catch (error) {
                console.error('Error fetching meteor data:', error);
                showError('Failed to load meteor data. Please refresh the page.');
            }
        }

        // Initial fetch and periodic updates
        fetchMeteors();
        setInterval(fetchMeteors, 60000); // Update every minute
    </script>
</body>
</html> 